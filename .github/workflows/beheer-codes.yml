name: Beheer (refill + assign) ‚Äî codes.json in calculator (PR-flow)

on:
  issues:
    types: [opened, edited, labeled, reopened]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  process:
    # Alleen draaien als het issue het 'beheer' label heeft
    if: contains(github.event.issue.labels.*.name, 'beheer')
    runs-on: ubuntu-latest

    steps:
      # (failsafe) auto-label 'beheer' als de titel met [Codes] begint
      - name: Auto-label beheer bij [Codes] in titel
        if: startsWith(github.event.issue.title, '[Codes]')
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: "beheer"

      # Checkout beheer (voor dealers.json en config)
      - name: Checkout beheer-repo
        uses: actions/checkout@v4

      # Checkout calculator (target) naar ./target
      - name: Checkout calculator-repo (target)
        uses: actions/checkout@v4
        with:
          repository: fietsserviceid/fiets-inruil-calculator
          token: ${{ secrets.TARGET_REPO_PAT }}   # secret moet RW op target hebben
          path: target
          ref: main

      # Verifieer dat target/codes.json bestaat
      - name: Verify target/codes.json
        shell: bash
        run: |
          if [ ! -f "target/codes.json" ]; then
            echo "ERROR: target/codes.json bestaat niet. Voeg het bestand toe in fiets-inruil-calculator (root) en probeer opnieuw."
            exit 1
          fi

      # Parse Issue Form (GEFIXT: juiste action & tag)
      - name: Parse Issue Form
        id: form
        uses: peter-murray/issue-forms-body-parser@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          token: ${{ secrets.GITHUB_TOKEN }}

      # Logica voor refill / assign
      - name: Run manage (refill/assign)
        id: manage
        shell: bash
        env:
          LABELS: ${{ join(github.event.issue.labels.*.name, ',') }}
          FORM:   ${{ steps.form.outputs.data }}
        run: |
          set -euo pipefail

          # Werkbestanden
          cp target/codes.json ./codes.json

          # Dealerslijst komt uit de beheer-repo (niet uit calculator)
          if [ -f "dealers.json" ]; then
            cp dealers.json ./dealers.json
          else
            echo "[]" > ./dealers.json
          fi

          cat > manage.js <<'NODE'
          const fs = require('fs');

          const now = new Date().toISOString();
          const codesPath   = 'codes.json';
          const dealersPath = 'dealers.json';

          const readJson = (p, fb=[]) => { try { return JSON.parse(fs.readFileSync(p,'utf8')); } catch { return fb; } };
          const writeJson = (p, obj) => fs.writeFileSync(p, JSON.stringify(obj, null, 2));

          const labels  = (process.env.LABELS || '').split(',').map(s=>s.trim()).filter(Boolean);
          const payload = JSON.parse(process.env.FORM || '{}');

          // Haal veldwaarden op aan de hand van de TITEL in je Issue Form
          const byTitle = (t) => {
            const vals = Object.values(payload || {});
            const f = vals.find(v => v && typeof v.title==='string' && v.title.trim().toLowerCase()===t.trim().toLowerCase());
            if (!f) return '';
            if (typeof f.text==='string') return f.text;
            if (typeof f==='string') return f;
            return '';
          };

          // Helpers
          const CODE_REGEX = /^FSID-[A-Z]{4}-\d{4}-\d{4}$/;     // codeformat afdwingen
          const isDMY = (s) => /^\d{2}-\d{2}-\d{4}$/.test(s);   // dd-mm-jjjj
          const pick = (s) => s[Math.floor(Math.random()*s.length)];
          const genFromFormat = (fmt='FSID-AAAA-9999-9999') => {
            const A='ABCDEFGHJKLMNPQRSTUVWXYZ'; const N='0123456789';
            return [...fmt].map(ch => ch==='A'?pick(A):ch==='9'?pick(N):ch).join('');
          };

          // Data
          const codes   = readJson(codesPath, []);
          const dealers = readJson(dealersPath, []);

          // id-generator fsc-0001, fsc-0002, ...
          let max = 0;
          for (const c of codes) {
            const m = (c.id||'').match(/^fsc-(\d{4})$/i);
            if (m) max = Math.max(max, parseInt(m[1],10));
          }
          const nextId = (n)=> `fsc-${String(max+n).padStart(4,'0')}`;

          let msg = 'geen wijziging';

          // ---------- REFILL ----------
          if (labels.includes('codes:refill')) {
            const count  = Math.max(1, parseInt((byTitle('Aantal te genereren')||'').trim() || '200', 10));
            const dmyRaw = (byTitle('Vervaldatum (dd-mm-jjjj, optioneel)')||'').trim();
            const vervaltOp = dmyRaw ? (isDMY(dmyRaw) ? dmyRaw : null) : null;

            const pasted = (byTitle('Eigen codes (optioneel, √©√©n per regel)')||'')
              .split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

            const source = pasted.length ? pasted : Array.from({length: count}, ()=> genFromFormat());

            // Validatie format
            const bad = source.filter(c => !CODE_REGEX.test(c));
            if (bad.length) throw new Error(`Fout code-format: ${bad.join(', ')}`);

            // Uniciteit t.o.v. bestaande
            const existing = new Set(codes.map(c=>c.code));
            const dups = source.filter(c => existing.has(c));
            if (dups.length) throw new Error(`Dubbele codes t.o.v. bestaande set: ${dups.join(', ')}`);

            // Append (zonder dealer)
            source.forEach((code, i) => {
              const id = nextId(i+1);
              codes.push({
                id, code,
                status: 'actief',
                dealerId: null,
                dealerNaam: null,
                vervaltOp,               // dd-mm-jjjj of null
                aangemaaktOp: now,
                gebruiktOp: null,
                notities: ''
              });
            });

            msg = `chore(codes): refill +${source.length} (zonder dealer)`;
          }

          // ---------- ASSIGN ----------
          if (labels.includes('codes:assign')) {
            const dealerId = (byTitle('Dealer ID')||'').trim();
            if (!dealerId) throw new Error('Dealer ID ontbreekt.');

            // Dealer staat in beheer/dealers.json (niet in calculator)
            const dealer = dealers.find(d => d.dealerId===dealerId);
            if (!dealer) throw new Error(`Dealer niet gevonden in beheer/dealers.json: ${dealerId}`);

            const want  = Math.max(1, parseInt((byTitle('Aantal codes toe te wijzen')||'').trim() || '1', 10));
            const fixed = (byTitle('Specifieke bestaande codes (optioneel, √©√©n per regel)')||'')
              .split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

            let toAssign = [];

            if (fixed.length) {
              const bad = fixed.filter(c => !CODE_REGEX.test(c));
              if (bad.length) throw new Error(`Fout code-format: ${bad.join(', ')}`);
              for (const val of fixed) {
                const entry = codes.find(c => c.code===val);
                if (!entry) throw new Error(`Code niet gevonden in target/codes.json: ${val}`);
                if (entry.dealerId) throw new Error(`Code al toegewezen: ${val}`);
                toAssign.push(entry);
              }
            } else {
              toAssign = codes.filter(c => !c.dealerId).slice(0, want);
              if (toAssign.length < want) throw new Error(`Onvoldoende vrije codes. Gevraagd: ${want}, beschikbaar: ${toAssign.length}`);
            }

            toAssign.forEach(e => {
              e.dealerId   = dealer.dealerId;
              e.dealerNaam = dealer.naam || dealer.dealerNaam || dealer.dealer_id || dealer.dealerId;
              e.status     = 'toegewezen';
              e.notities   = (e.notities || '') + (e.notities ? ' ¬∑ ' : '') + 'toegewezen via beheer';
            });

            msg = `chore(codes): assigned ${toAssign.length} to ${dealerId}`;
          }

          writeJson(codesPath, codes);
          fs.writeFileSync('commit_msg.txt', msg);
          console.log(msg);
          NODE

          node manage.js

          # Mutatie terugschrijven naar target/
          mv ./codes.json target/codes.json

          # Commit message doorgeven
          echo "MSG=$(cat commit_msg.txt)" >> $GITHUB_OUTPUT

      # (optioneel) Debug: tel codes
      - name: Debug aantal codes
        run: |
          echo "Aantal entries in target/codes.json:"
          jq 'length' target/codes.json || true

      # PR aanmaken in calculator
      - name: Create PR in calculator
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.TARGET_REPO_PAT }}
          path: target
          commit-message: ${{ steps.manage.outputs.MSG }}
          title: ${{ steps.manage.outputs.MSG }}
          body: |
            Automatische update vanuit beheer-issue #${{ github.event.issue.number }}.
            (PR-flow; geen directe push)
          branch: chore/managed-codes-${{ github.event.issue.number }}
          labels: admin,internal

      # Altijd commenten; JS beslist welke tekst
      - name: Comment with PR link
        uses: actions/github-script@v7
        env:
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
        with:
          script: |
            const url = process.env.PR_URL || '';
            const body = url
              ? `üîÅ PR aangemaakt in calculator: ${url}`
              : '‚ÑπÔ∏è Geen PR aangemaakt (geen wijzigingen?)';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });
