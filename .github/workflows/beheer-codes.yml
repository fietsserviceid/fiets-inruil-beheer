name: Beheer (refill + assign) â€” codes.json in calculator (PR-flow)

on:
  issues:
    types: [opened, edited, labeled, reopened]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: beheer-codes
  cancel-in-progress: false

jobs:
  process:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'issues' && contains(join(github.event.issue.labels.*.name, ','), 'beheer')) }}
    runs-on: ubuntu-latest

    steps:
      - name: Auto-label beheer bij [Codes] in titel
        if: ${{ github.event_name == 'issues' && startsWith(github.event.issue.title, '[Codes]') }}
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: "beheer"

      - name: Checkout beheer-repo
        uses: actions/checkout@v4

      - name: Checkout calculator-repo (target)
        uses: actions/checkout@v4
        with:
          repository: fietsserviceid/fiets-inruil-calculator
          token: ${{ secrets.TARGET_REPO_PAT }}
          path: target
          ref: main

      - name: Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Verify target/codes.json
        shell: bash
        run: |
          set -euo pipefail
          test -f target/codes.json || { echo "ERROR: target/codes.json ontbreekt"; exit 1; }
          if ! jq -e 'has("codes") and (.codes|type=="array")' target/codes.json >/dev/null; then
            echo "ERROR: target/codes.json verwacht schema { price_eur_per_year, version, codes: [...] }"
            exit 1
          fi

      - name: Parse Issue Form
        if: ${{ github.event_name == 'issues' }}
        id: form
        uses: zentered/issue-forms-body-parser@v2.0.0

      - name: Run manage (refill/assign)
        id: manage
        shell: bash
        env:
          LABELS: ${{ github.event_name == 'issues' && join(github.event.issue.labels.*.name, ',') || '' }}
          FORM:   ${{ steps.form.outputs.data }}
        run: |
          set -euo pipefail

          cp target/codes.json ./codes.json
          [ -f dealers.json ] || echo "[]" > dealers.json

          cat > manage.js <<'NODE'
          const fs = require('fs');

          const nowIso = new Date().toISOString();
          const codesPath   = 'codes.json';
          const dealersPath = 'dealers.json';

          const readJson  = (p, fb=null) => { try { return JSON.parse(fs.readFileSync(p,'utf8')); } catch { return fb; } };
          const writeJson = (p, obj) => fs.writeFileSync(p, JSON.stringify(obj, null, 2));

          const labels = (process.env.LABELS || '')
            .split(',')
            .map(s => s.trim().toLowerCase())
            .filter(Boolean);

          const payload = JSON.parse(process.env.FORM || '{}');

          const normalize = (s) => (s || '').toString().trim();

          const isNoResponse = (txt) => {
            const t = normalize(txt).replace(/^>\s*/, '').toLowerCase();
            return !t || t === 'no response' || t === 'geen antwoord' || t === 'nvt' || t === 'n/a' || t === '-';
          };

          const byTitleRaw = (t) => {
            const vals = Object.values(payload || {});
            const f = vals.find(v => v && typeof v.title === 'string' && v.title.trim().toLowerCase() === t.trim().toLowerCase());
            if (!f) return '';
            if (typeof f.text === 'string') return f.text;
            if (typeof f === 'string') return f;
            return '';
          };

          const byTitle = (t) => {
            const val = byTitleRaw(t);
            return isNoResponse(val) ? '' : normalize(val);
          };

          const toInt = (txt, def) => {
            const n = parseInt(normalize(txt), 10);
