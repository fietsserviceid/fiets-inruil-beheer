name: Beheer (complete) ‚Äî codes.json in calculator (PR-flow)

on:
  issues:
    types: [opened, edited, labeled, reopened]
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: beheer-codes
  cancel-in-progress: false

jobs:
  process:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'issues' && contains(join(github.event.issue.labels.*.name, ','), 'beheer')) }}
    runs-on: ubuntu-latest

    steps:
      - name: Auto-label beheer bij [Codes] in titel
        if: ${{ github.event_name == 'issues' && startsWith(github.event.issue.title, '[Codes]') }}
        uses: actions-ecosystem/action-add-labels@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          labels: "beheer"

      - name: Checkout beheer-repo
        uses: actions/checkout@v4

      - name: Checkout calculator-repo (target)
        uses: actions/checkout@v4
        with:
          repository: fietsserviceid/fiets-inruil-calculator
          token: ${{ secrets.TARGET_REPO_PAT }}
          path: target
          ref: main

      - name: Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Verify target/codes.json
        shell: bash
        run: |
          set -euo pipefail
          test -f target/codes.json || { echo "ERROR: target/codes.json ontbreekt"; exit 1; }
          if ! jq -e 'has("codes") and (.codes|type=="array")' target/codes.json >/dev/null; then
            echo "ERROR: target/codes.json verwacht schema { price_eur_per_year, version, codes: [...] }"
            exit 1
          fi

      - name: Parse Issue Form
        if: ${{ github.event_name == 'issues' }}
        id: form
        uses: zentered/issue-forms-body-parser@v2.0.0

      # ----------------------------------------------------------------------------
      # NIEUW: Automatisch een comment met alle vrije codes bij Assign-issues
      # ----------------------------------------------------------------------------
      - name: List free codes (auto-comment for assign issues)
        if: ${{ github.event_name == 'issues' && (contains(join(github.event.issue.labels.*.name, ','), 'codes:assign') || github.event.action == 'labeled') }}
        id: listfree
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const raw = fs.readFileSync('target/codes.json', 'utf8');
              const data = JSON.parse(raw);
              if (!data.codes || !Array.isArray(data.codes)) {
                core.setFailed("codes.json bevat geen 'codes' array");
                return;
              }
              const free = data.codes.filter(c => !c.issued_to).map(c => c.code);
              let body;
              if (!free.length) {
                body = '‚ö†Ô∏è Er zijn momenteel **geen vrije codes** beschikbaar.\n' +
                       'Je kunt er nieuwe genereren via: *Codes ‚Äì Refill (genereren)*.';
              } else {
                body = 'üîé **Vrije codes die je kunt toewijzen ('+free.length+')**:\n\n' +
                       free.map(c => '- `'+c+'`').join('\n') +
                       '\n\nüëâ Plak de gewenste code in het veld **Specifieke bestaande codes** als je een specifieke code wilt toewijzen.';
              }
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            } catch (e) {
              core.setFailed('Kon target/codes.json niet lezen: '+ e.message);
            }

      # ----------------------------------------------------------------------------
      # HOOFDLOGICA: refill / assign / block / unblock / status / verval / release / dealer:upsert
      # ----------------------------------------------------------------------------
      - name: Run manage (full logic)
        id: manage
        shell: bash
        env:
          LABELS: ${{ github.event_name == 'issues' && join(github.event.issue.labels.*.name, ',') || '' }}
          FORM:   ${{ steps.form.outputs.data }}
        run: |
          set -euo pipefail

          cp target/codes.json ./codes.json
          [ -f dealers.json ] || echo "[]" > dealers.json

          cat > manage.js <<'NODE'
          const fs = require('fs');

          const nowIso = new Date().toISOString();
          const codesPath   = 'codes.json';
          const dealersPath = 'dealers.json';

          const readJson  = (p, fb=null) => { try { return JSON.parse(fs.readFileSync(p,'utf8')); } catch { return fb; } };
          const writeJson = (p, obj) => fs.writeFileSync(p, JSON.stringify(obj, null, 2));

          const labels = (process.env.LABELS || '')
            .split(',')
            .map(s => s.trim().toLowerCase())
            .filter(Boolean);

          const payload = JSON.parse(process.env.FORM || '{}');

          const normalize = (s) => (s || '').toString().trim();
          const isNoResponse = (txt) => {
            const t = normalize(txt).replace(/^>\s*/, '').toLowerCase();
            return !t || ['no response','geen antwoord','nvt','n/a','-'].includes(t);
          };
          const byTitleRaw = (t) => {
            const vals = Object.values(payload || {});
            const f = vals.find(v => v && typeof v.title === 'string' && v.title.trim().toLowerCase() === t.trim().toLowerCase());
            return (typeof f?.text === 'string') ? f.text : (typeof f === 'string' ? f : '');
          };
          const byTitle = (t) => { const val = byTitleRaw(t); return isNoResponse(val) ? '' : normalize(val); };

          const toInt = (txt, def) => { const n = parseInt(normalize(txt), 10); return Number.isFinite(n) && n > 0 ? n : def; };
          const toYes = (txt) => ['ja','yes','y','true','1'].includes(normalize(txt).toLowerCase());
          const isDMY = (s) => /^\d{2}-\d{2}-\d{4}$/.test(normalize(s));

          const root = readJson(codesPath, null);
          if (!root || !Array.isArray(root.codes)) throw new Error("codes.json mist 'codes' array");
          const list = root.codes;

          const existing = new Set(list.map(e => e?.code).filter(Boolean));

          let msg = 'geen wijziging';
          let changed = false;

          const CODE_REGEX = /^FSID-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}$/;

          // REFILL
          if (labels.includes('codes:refill')) {
            const count  = toInt(byTitle('Aantal te genereren'), 200);
            const dmyRaw = byTitle('Vervaldatum (dd-mm-jjjj, optioneel)');
            const expires = dmyRaw || null;

            const pastedRaw = byTitle('Eigen codes (optioneel, √©√©n per regel)');
            const pasted = pastedRaw ? pastedRaw.split(/\r?\n/).map(s=>s.trim().toUpperCase()).filter(s=>s && !isNoResponse(s)) : [];

            const pick = s => s[Math.floor(Math.random()*s.length)];
            const genCode = () => { const AL='ABCDEFGHJKLMNPQRSTUVWXYZ0123456789'; const blk=()=>Array.from({length:4},()=>pick(AL)).join(''); return `FSID-${blk()}-${blk()}-${blk()}`; };
            const source = pasted.length ? pasted : Array.from({length:count}, genCode);

            const bad  = source.filter(c => !CODE_REGEX.test(c)); if (bad.length) throw new Error(`Fout code-format: ${bad.join(', ')}`);
            const dups = source.filter(c => existing.has(c));    if (dups.length) throw new Error(`Dubbele codes t.o.v. bestaande set: ${dups.join(', ')}`);

            for (const code of source) { list.push({ code, active:true, note:"", expires, issued_to:null, issued_at:null }); existing.add(code); }
            msg = `chore(codes): refill +${source.length}`; changed = true;
          }

          // ASSIGN
          if (labels.includes('codes:assign')) {
            const dealerId = byTitle('Dealer ID'); if (!dealerId) throw new Error('Dealer ID ontbreekt.');
            const dealers  = readJson(dealersPath, []);
            const dealer   = dealers.find(d => d.dealerId === dealerId); if (!dealer) throw new Error(`Dealer niet gevonden: ${dealerId}`);

            const want  = toInt(byTitle('Aantal codes toe te wijzen'), 1);
            const exp   = byTitle('Vervaldatum (dd-mm-jjjj, optioneel)'); const expAssign = exp || null;
            const fixedRaw = byTitle('Specifieke bestaande codes (optioneel, √©√©n per regel)');
            const fixed = fixedRaw ? fixedRaw.split(/\r?\n/).map(s=>s.trim().toUpperCase()).filter(s=>s && !isNoResponse(s)) : [];

            let toAssign = [];
            if (fixed.length) {
              const bad = fixed.filter(c => !CODE_REGEX.test(c)); if (bad.length) throw new Error(`Fout code-format: ${bad.join(', ')}`);
              for (const val of fixed) {
                const entry = list.find(e => e && e.code === val); if (!entry) throw new Error(`Code niet gevonden: ${val}`); if (entry.issued_to) throw new Error(`Code al toegewezen: ${val}`); toAssign.push(entry);
              }
            } else {
              toAssign = list.filter(e=>e && !e.issued_to).slice(0, want); if (toAssign.length < want) throw new Error(`Onvoldoende vrije codes (gevonden: ${toAssign.length})`);
            }

            toAssign.forEach(e=>{ e.issued_to = dealerId; e.issued_at = nowIso; if (expAssign!==null) e.expires = expAssign; });
            msg = `chore(codes): assigned ${toAssign.length} to ${dealerId}`; changed = true;
          }

          // BLOCK / UNBLOCK
          const toggleActive = (makeActive) => {
            const fixedRaw = byTitle('Specifieke bestaande codes (optioneel, √©√©n per regel)');
            const dealerId = byTitle('Dealer ID');
            const allFlag = toYes(byTitle('Alle codes van dealer? (ja/nee)'));

            let targets = [];
            if (fixedRaw) {
              const fixed = fixedRaw.split(/\r?\n/).map(s=>s.trim().toUpperCase()).filter(Boolean);
              const bad = fixed.filter(c=>!CODE_REGEX.test(c)); if (bad.length) throw new Error(`Fout code-format: ${bad.join(', ')}`);
              for (const val of fixed) { const entry = list.find(e=>e && e.code===val); if (!entry) throw new Error(`Code niet gevonden: ${val}`); targets.push(entry); }
            } else if (dealerId && allFlag) {
              targets = list.filter(e=>e && e.issued_to===dealerId); if (!targets.length) throw new Error(`Geen codes gevonden voor dealer: ${dealerId}`);
            } else { throw new Error('Geen doelcodes opgegeven.'); }

            let affected=0; targets.forEach(e=>{ if (!!e.active !== makeActive) { e.active = makeActive; affected++; } });
            return affected;
          };
          if (labels.includes('codes:block')) { const n = toggleActive(false); msg = `chore(codes): blocked ${n} codes`; changed = changed || (n>0); }
          if (labels.includes('codes:unblock')) { const n = toggleActive(true);  msg = `chore(codes): unblocked ${n} codes`; changed = changed || (n>0); }

          // STATUS (single)
          if (labels.includes('codes:status')) {
            const codeId = byTitle('Code ID of code waarde'); const newStatus = byTitle('Nieuwe status'); const notesRaw = byTitle('Notities (optioneel)');
            if (!codeId) throw new Error('Code ID ontbreekt.'); if (!newStatus) throw new Error('Nieuwe status ontbreekt.');
            const entry = list.find(e=>e && e.code===codeId); if (!entry) throw new Error(`Code niet gevonden: ${codeId}`);
            entry.active = newStatus.toLowerCase()==='actief'; if (notesRaw) entry.note = notesRaw; msg = `chore(codes): status updated for ${entry.code}`; changed = true;
          }

          // VERVALDATUM
          if (labels.includes('codes:verval')) {
            const codeId = byTitle('Code ID of code waarde'); const newExp = byTitle('Nieuwe vervaldatum (dd-mm-jjjj)');
            if (!codeId) throw new Error('Code ID ontbreekt.'); if (!newExp) throw new Error('Nieuwe datum ontbreekt.');
            const entry = list.find(e=>e && e.code===codeId); if (!entry) throw new Error(`Code niet gevonden: ${codeId}`);
            if (!isDMY(newExp)) throw new Error('Gebruik formaat dd-mm-jjjj.');
            entry.expires = newExp; msg = `chore(codes): vervaldatum aangepast voor ${entry.code}`; changed = true;
          }

          // RELEASE
          if (labels.includes('codes:release')) {
            const dealerId = byTitle('Dealer ID'); const allFlag = toYes(byTitle('Alle codes van dealer? (ja/nee)'));
            const fixedRaw = byTitle('Specifieke bestaande codes (optioneel, √©√©n per regel)');
            let targets = [];
            if (fixedRaw) {
              const fixed = fixedRaw.split(/\r?\n/).map(s=>s.trim().toUpperCase()).filter(Boolean);
              const bad = fixed.filter(c=>!CODE_REGEX.test(c)); if (bad.length) throw new Error(`Fout code-format: ${bad.join(', ')}`);
              for (const val of fixed) { const entry = list.find(e=>e && e.code===val); if (!entry) throw new Error(`Code niet gevonden: ${val}`); if (!entry.issued_to) throw new Error(`Code is al vrij: ${val}`); targets.push(entry); }
            } else if (dealerId && allFlag) {
              targets = list.filter(e=>e && e.issued_to===dealerId); if (!targets.length) throw new Error(`Geen toegewezen codes gevonden voor dealer: ${dealerId}`);
            } else { throw new Error('Geen doelcodes opgegeven.'); }
            targets.forEach(e=>{ e.issued_to=null; e.issued_at=null; });
            msg = `chore(codes): released ${targets.length} codes`; changed = changed || (targets.length>0);
          }

          // DEALER UPSERT
          if (labels.includes('dealer:upsert')) {
            const dealerId = byTitle('Dealer ID'); if (!dealerId) throw new Error('Dealer ID ontbreekt.');
            const naam = byTitle('Naam'); const email = byTitle('E-mail'); const tel = byTitle('Telefoon'); const notes = byTitle('Notities'); const adresRaw = byTitle('Adres (JSON)');
            let adres=null; if (adresRaw) { try { adres=JSON.parse(adresRaw); } catch { adres={raw:adresRaw}; } }
            const dealers = readJson(dealersPath, []); const i = dealers.findIndex(d=>d.dealerId===dealerId);
            const obj = { dealerId, name: naam||'', email: email||'', phone: tel||'', address: adres, notes, updatedAt: nowIso };
            if (i>=0) dealers[i] = { ...dealers[i], ...obj }; else dealers.push({ createdAt: nowIso, ...obj });
            writeJson(dealersPath, dealers); msg = `chore(dealer): upsert ${dealerId}`; changed = true;
          }

          // SAVE
          writeJson(codesPath, root);
          require('fs').writeFileSync('commit_msg.txt', msg);
          require('fs').writeFileSync('changed.out', String(changed));
          console.log(msg);
          NODE

          node manage.js
          mv ./codes.json target/codes.json

          echo "MSG=$(cat commit_msg.txt)" >> $GITHUB_OUTPUT
          echo "CHANGED=$(cat changed.out)" >> $GITHUB_OUTPUT

      - name: Debug aantal codes
        run: |
          echo "Aantal entries in target/codes.json (codes[]):"
          jq '.codes | length' target/codes.json || true

      - name: Create PR in calculator (alleen bij wijzigingen)
        if: ${{ steps.manage.outputs.CHANGED == 'true' }}
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.TARGET_REPO_PAT }}
          path: target
          commit-message: ${{ steps.manage.outputs.MSG }}
          title: ${{ steps.manage.outputs.MSG }}
          body: |
            Automatische update vanuit beheer-issue #${{ github.event.issue.number || 'manual' }}.
            (PR-flow; geen directe push)
          branch: chore/managed-codes-${{ github.event.issue.number || github.run_id }}
          labels: admin,internal

      - name: Comment with PR link (alleen bij issues)
        if: ${{ github.event_name == 'issues' }}
        uses: actions/github-script@v7
        env:
          PR_URL: ${{ steps.cpr.outputs['pull-request-url'] }}
          MSG:    ${{ steps.manage.outputs.MSG }}
          CHG:    ${{ steps.manage.outputs.CHANGED }}
        with:
          script: |
            const url = process.env.PR_URL || '';
            const changed = (process.env.CHG || '').toLowerCase() === 'true';
            let body;
            if (!changed) {
              body = `‚ÑπÔ∏è Geen wijzigingen gedetecteerd ‚Äî er is geen PR aangemaakt.\n\nZorg dat het issue labels bevat als **codes:refill**, **codes:assign**, **codes:block**, **codes:unblock**, **codes:release**, **codes:status**, **codes:verval**, **dealer:upsert** (en **beheer**).`;
            } else {
              body = url ? `üîÅ PR aangemaakt in calculator: ${url}` : '‚ÑπÔ∏è Wijzigingen verwerkt, maar geen PR-URL ontvangen.';
            }
            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body });
